<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Your Books | NextDoorReads</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header injected on all pages -->
    <div id="site-header"></div>
    <script>
      fetch('header.html')
        .then(res => res.text())
        .then(html => document.getElementById('site-header').innerHTML = html);
    </script>

    <main class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h2 class="h4 mb-0"><i class="bi bi-book me-2"></i>List a Book for Sale</h2>
                        </div>
                        <div class="card-body">
                            <form id="bookUploadForm">
                                <!-- Step 1: Book Details -->
                                <div class="mb-4" id="step1">
                                    <h3 class="h5 mb-3 border-bottom pb-2">1. Book Information</h3>
                                    <div class="mb-3">
                                        <label for="bookTitle" class="form-label">Book Title *</label>
                                        <input type="text" class="form-control" id="bookTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="bookAuthor" class="form-label">Author *</label>
                                        <input type="text" class="form-control" id="bookAuthor" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="bookIsbn" class="form-label">ISBN (optional)</label>
                                        <input type="text" class="form-control" id="bookIsbn" placeholder="10 or 13 digit number">
                                        <small class="text-muted">Adding ISBN helps fetch cover automatically</small>
                                    </div>
                                    <input type="hidden" id="coverUrl" name="coverUrl">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="bookGenre" class="form-label">Genre *</label>
                                            <select class="form-select" id="bookGenre" required>
                                                <!-- options -->
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="bookLanguage" class="form-label">Language *</label>
                                            <select class="form-select" id="bookLanguage" required>
                                                <!-- options -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="bookDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="bookDescription" rows="3" placeholder="..." ></textarea>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-primary" onclick="nextStep(1,2)">Next: Condition & Pricing</button>
                                    </div>
                                </div>
                                <!-- Further steps unchanged -->
                                <!-- ... include steps 2,3,4 with existing markup unchanged ... -->
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-5">
        <!-- Same footer as previous pages -->
    </footer>

    <!-- Firebase + Auth + Firestore + Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="auth.js"></script>
    <script src="script.js"></script>

    <script>
    // ISBN cover lookup
    document.getElementById('bookIsbn').addEventListener('blur', async function() {
        const isbn = this.value.trim(); if (!isbn) return;
        const url = `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;
        const img = new Image();
        img.onload = () => {
            document.getElementById('reviewBookImage').innerHTML = '';
            img.style.width='100%'; img.style.height='auto';
            document.getElementById('reviewBookImage').appendChild(img);
            document.getElementById('coverUrl').value = url;
        };
        img.onerror = () => console.warn('No cover for', isbn);
        img.src = url;
    });

    // Override form submit to save to Firestore
    document.getElementById('bookUploadForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const user = firebase.auth().currentUser;
        if(!user){ alert('Please log in first'); return; }
        if(!document.getElementById('agreeTerms').checked){ alert('Agree to Terms'); return; }
        // upload user photos
        const files = document.getElementById('bookPhotos').files;
        const uploadTasks = [];
        for(let i=0;i<files.length;i++){
            const file=files[i];
            const ref = firebase.storage().ref(`listings/${user.uid}/${Date.now()}_${i}`);
            uploadTasks.push(ref.put(file).then(()=>ref.getDownloadURL()));
        }
        const photoUrls = await Promise.all(uploadTasks);
        // Save listing
        await firebase.firestore().collection('listings').add({
            owner: user.uid,
            title: document.getElementById('bookTitle').value,
            author: document.getElementById('bookAuthor').value,
            isbn: document.getElementById('bookIsbn').value,
            coverUrl: document.getElementById('coverUrl').value || photoUrls[0],
            photos: photoUrls,
            condition: document.getElementById('bookCondition').value,
            price: parseFloat(document.getElementById('bookPrice').value),
            negotiable: document.getElementById('priceNegotiable').checked,
            location: document.getElementById('bookLocation').value,
            locationDetails: document.getElementById('locationDetails').value,
            description: document.getElementById('bookDescription').value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        new bootstrap.Modal(document.getElementById('successModal')).show();
    });
    </script>
</body>
</html>